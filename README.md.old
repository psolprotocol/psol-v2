# pSOL v2

pSOL v2 is a privacy protocol for Solana that enables confidential transfers of SPL tokens through a shared, multi-asset shielded pool. The protocol combines zero-knowledge proofs with an on-chain commitment tree and off-chain batching to achieve practical throughput while keeping on-chain verification bounded.

This repository contains the Solana programs, Circom circuits, relayer and sequencer services, a TypeScript SDK, and deployment scripts.

## Status

Network: Solana Devnet

Release: Experimental, under active development

## Capabilities

The protocol supports shielded pools for multiple SPL token mints, Groth16 proofs over BN254, Poseidon-based commitments, Merkle tree membership proofs, and batched settlement of pending deposits through an off-chain sequencer.

## Repository Structure

| Directory | Description |
|-----------|-------------|
| programs/ | Solana programs for pool state, deposit settlement, and withdrawals |
| circuits/ | Circom circuits and compiled artifacts for ZK proof generation |
| relayer/ | Off-chain service for batching, proof generation, and client endpoints |
| sdk/ | TypeScript SDK for transactions, notes, and proof construction |
| scripts/ | Deployment, initialization, and registry management tooling |

## Devnet Deployment

Program ID: `BmtMrkgvVML9Gk7Bt6JRqweHAwW69oFTohaBRaLbgqpb`

### Active Pool

| Component | Address |
|-----------|---------|
| Pool Config | `FX26qtKeJN7fUPKfHF17bwhUv2Fah3rS2K1t9AVpcEXj` |
| Merkle Tree | `6zLFi4vgvaZShwBfFBdYwvfpgLYCE2f698GiiVpdhKgy` |
| Pending Buffer | `7DnGtZ3PWv89gtqryJky7HpvM62UHpj4JJ4txmzLMwUA` |
| Pool Authority | `Ar5yGZjo3VpV1e7XRqqNJkBVphRVa8qxYigUKPQVePJXR` |

## Protocol Overview

pSOL v2 uses a two-phase deposit flow designed around Solana's compute constraints.

### Deposit Phase

A user submits a deposit instruction with a ZK proof. The commitment is appended to an on-chain pending buffer.

### Settlement Phase

A sequencer batches pending commitments, constructs the Merkle update off-chain, generates a batch proof, and submits a settlement instruction to update the Merkle tree. This approach amortizes insertion costs and keeps on-chain verification bounded.

```
User deposit
    |
    v
Pending buffer (on-chain)
    |
    v
Sequencer batches commitments (off-chain)
    |
    v
Batch proof generation
    |
    v
settle_deposits_batch (on-chain)
    |
    v
Merkle tree updated
```

## Relayer Service

The relayer operates as a long-lived service that provides client endpoints and runs the sequencer loop.

### Endpoints

| Endpoint | Description |
|----------|-------------|
| GET /api/health | Service health status |
| GET /api/pool-state | Current pool and Merkle tree state |
| GET /api/note/:commitment | Note status lookup |

### Configuration

Runtime configuration is controlled through environment variables. See the relayer directory for details.

## Development

### Requirements

| Tool | Version |
|------|---------|
| Rust | 1.75+ |
| Solana CLI | 1.18+ |
| Anchor | 0.30+ |
| Node.js | 18+ |
| circom | 2.1+ |
| snarkjs | 0.7+ |

### Environment

For Anchor workflows on Devnet:

```bash
export ANCHOR_PROVIDER_URL="https://api.devnet.solana.com"
export ANCHOR_WALLET="$HOME/.config/solana/id.json"
```

### Tests

```bash
cargo test -p psol-privacy-v2
```

## Security Considerations

This is experimental software intended for development and testing.

The circuits have not been formally audited. The trusted setup is not protocol-dedicated. Mainnet deployment requires a security audit, a dedicated trusted setup ceremony, and a complete threat model.

## License

MIT