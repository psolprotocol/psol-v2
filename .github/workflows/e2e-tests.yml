# pSOL v2 E2E Integration Tests
#
# Runs the full deposit → Merkle update → withdraw flow test suite.
# Triggered on changes to protocol, SDK, or relayer code.
#
# @see https://github.com/psolprotocol/psol-v2/issues/19

name: E2E Integration Tests

on:
  push:
    branches: [main, develop]
    paths:
      - 'programs/**'
      - 'sdk/**'
      - 'relayer/**'
      - 'circuits/**'
      - 'tests/**'
      - 'Anchor.toml'
      - 'package.json'
      - '.github/workflows/e2e-tests.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'programs/**'
      - 'sdk/**'
      - 'relayer/**'
      - 'circuits/**'
      - 'tests/**'
      - 'Anchor.toml'
      - 'package.json'
      - '.github/workflows/e2e-tests.yml'
  workflow_dispatch:
    inputs:
      skip_circuits:
        description: 'Skip circuit compilation (use mock proofs)'
        required: false
        default: 'true'
        type: boolean

env:
  SOLANA_VERSION: '1.18.15'
  ANCHOR_VERSION: '0.30.1'
  NODE_VERSION: '20'
  RUST_VERSION: 'stable'

jobs:
  # ============================================================================
  # Build and Test the Rust Program
  # ============================================================================
  build-program:
    name: Build Anchor Program
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-action@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          components: clippy, rustfmt

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: 'programs/psol-privacy-v2 -> target'

      - name: Install Solana CLI
        run: |
          sh -c "$(curl -sSfL https://release.solana.com/v${{ env.SOLANA_VERSION }}/install)"
          echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH

      - name: Install Anchor CLI
        run: |
          npm install -g @coral-xyz/anchor-cli@${{ env.ANCHOR_VERSION }}

      - name: Generate Solana keypair
        run: |
          solana-keygen new --no-bip39-passphrase -o ~/.config/solana/id.json

      - name: Build Anchor program
        run: anchor build

      - name: Upload program artifacts
        uses: actions/upload-artifact@v4
        with:
          name: program-artifacts
          path: |
            target/deploy/*.so
            target/idl/*.json
            target/types/*.ts
          retention-days: 7

  # ============================================================================
  # Build SDK
  # ============================================================================
  build-sdk:
    name: Build TypeScript SDK
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install root dependencies
        run: npm ci --ignore-scripts || npm install --ignore-scripts

      - name: Install SDK dependencies
        working-directory: sdk
        run: npm ci || npm install

      - name: Build SDK
        working-directory: sdk
        run: npm run build

      - name: Run SDK unit tests
        working-directory: sdk
        run: npm test || echo "SDK tests not configured yet"

      - name: Upload SDK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sdk-artifacts
          path: sdk/dist
          retention-days: 7

  # ============================================================================
  # E2E Integration Tests
  # ============================================================================
  e2e-tests:
    name: E2E Integration Tests
    runs-on: ubuntu-latest
    needs: [build-program, build-sdk]
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Setup Rust
        uses: dtolnay/rust-action@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: 'programs/psol-privacy-v2 -> target'

      - name: Install Solana CLI
        run: |
          sh -c "$(curl -sSfL https://release.solana.com/v${{ env.SOLANA_VERSION }}/install)"
          echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH

      - name: Install Anchor CLI
        run: |
          npm install -g @coral-xyz/anchor-cli@${{ env.ANCHOR_VERSION }}

      - name: Generate Solana keypair
        run: |
          solana-keygen new --no-bip39-passphrase -o ~/.config/solana/id.json

      - name: Download program artifacts
        uses: actions/download-artifact@v4
        with:
          name: program-artifacts
          path: target

      - name: Download SDK artifacts
        uses: actions/download-artifact@v4
        with:
          name: sdk-artifacts
          path: sdk/dist

      - name: Install dependencies
        run: |
          npm ci --ignore-scripts || npm install --ignore-scripts

      - name: Install test dependencies
        run: |
          npm install -D ts-mocha typescript @types/node @types/mocha @types/chai chai mocha circomlibjs

      - name: Install SDK dependencies
        working-directory: sdk
        run: npm ci || npm install

      - name: Start local validator
        run: |
          solana-test-validator --reset &
          sleep 10

      - name: Deploy program to local validator
        run: |
          anchor deploy --provider.cluster localnet || echo "Deploy skipped - program artifacts may not be available"

      - name: Run E2E tests
        run: |
          npx ts-mocha -p tests/tsconfig.json tests/**/*.ts --timeout 120000 --exit
        env:
          ANCHOR_PROVIDER_URL: http://127.0.0.1:8899
          ANCHOR_WALLET: ~/.config/solana/id.json

      - name: Stop local validator
        if: always()
        run: |
          pkill -f solana-test-validator || true

  # ============================================================================
  # SDK Merkle Tree Verification Tests
  # ============================================================================
  sdk-merkle-tests:
    name: SDK Merkle Verification Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci --ignore-scripts || npm install --ignore-scripts

      - name: Install test dependencies
        run: |
          npm install -D ts-mocha typescript @types/node @types/mocha @types/chai chai mocha circomlibjs

      - name: Run Merkle verification tests
        run: |
          npx ts-mocha -p tests/tsconfig.json tests/**/*.ts --grep "SDK Merkle Tree" --timeout 60000 --exit

  # ============================================================================
  # Circuit Compilation (Optional)
  # ============================================================================
  compile-circuits:
    name: Compile ZK Circuits
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_circuits && github.event_name != 'pull_request' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install circom
        run: |
          cargo install circom || echo "Circom already installed"

      - name: Install snarkjs
        run: |
          npm install -g snarkjs

      - name: Install circuit dependencies
        working-directory: circuits
        run: |
          npm install circomlib || mkdir -p node_modules && npm install circomlib

      - name: Compile deposit circuit
        working-directory: circuits/deposit
        run: |
          circom deposit.circom --r1cs --wasm --sym -o . || echo "Circuit compilation skipped"

      - name: Compile withdraw circuit
        working-directory: circuits/withdraw
        run: |
          circom withdraw.circom --r1cs --wasm --sym -o . || echo "Circuit compilation skipped"

      - name: Upload circuit artifacts
        uses: actions/upload-artifact@v4
        with:
          name: circuit-artifacts
          path: |
            circuits/**/**.wasm
            circuits/**/**.r1cs
            circuits/**/**.sym
          retention-days: 7
          if-no-files-found: ignore

  # ============================================================================
  # Test Summary
  # ============================================================================
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [e2e-tests, sdk-merkle-tests]
    if: always()
    steps:
      - name: Check test results
        run: |
          echo "## E2E Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.e2e-tests.result }}" == "success" ]; then
            echo "✅ E2E Integration Tests: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ E2E Integration Tests: ${{ needs.e2e-tests.result }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.sdk-merkle-tests.result }}" == "success" ]; then
            echo "✅ SDK Merkle Tests: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ SDK Merkle Tests: ${{ needs.sdk-merkle-tests.result }}" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail if tests failed
        if: needs.e2e-tests.result == 'failure' || needs.sdk-merkle-tests.result == 'failure'
        run: exit 1
