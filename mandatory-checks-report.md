# Mandatory Checks Report

This report details the findings for the mandatory checks (C, D, E) outlined in the audit request.

## C) Merkle Depth Inconsistency (Stop-Ship Issue)

A critical mismatch exists between the hardcoded Merkle tree depth in the ZK circuit and the depth used in the on-chain pool initialization script. This will cause all withdrawal proofs to fail verification.

*   **Circuit (`circuits/withdraw/withdraw.circom`):**
    *   **Evidence:** The main component of the withdrawal circuit is instantiated with a hardcoded depth of **20**.
    *   **Code:** `component main { ... } = Withdraw(20);`
    *   **Implication:** Proofs generated by `snarkjs` will expect a Merkle path of length 20.

*   **Initialization Script (`scripts/ts/init-pool.ts`):**
    *   **Evidence:** The script that creates the on-chain pool and its associated Merkle tree account sets the depth to **4**.
    *   **Code:** `const treeDepth = 4;`
    *   **Implication:** The on-chain program will manage a Merkle tree with a maximum of 16 (2^4) leaves and expect a Merkle path of length 4 during verification.

*   **Conclusion:** This is a **stop-ship issue**. No withdrawal proof can succeed because the proof's structure (depth 20) is fundamentally incompatible with the on-chain tree's structure (depth 4).

## D) Circuit Artifacts Path Mismatches

The Relayer and the SDK both have hardcoded paths to the circuit build artifacts that do not match the actual output paths from the `circuits/build.sh` script. This will cause runtime failures when attempting to load the verification key (in the relayer) or generate a proof (in the SDK).

### Relayer Path Mismatch

*   **Relayer (`relayer/src/index.ts`):**
    *   **Expected Path:** The relayer code expects the withdrawal verification key at a path defined by `process.env.WITHDRAW_VK_PATH` or defaults to `./circuits/withdraw/withdraw.vkey.json`.
    *   **Code:** `withdrawVkPath: process.env.WITHDRAW_VK_PATH || './circuits/withdraw/withdraw.vkey.json'`

*   **Build Script (`circuits/build.sh`):**
    *   **Actual Path:** The build script generates the verification key in the `build` directory.
    *   **Code:** `snarkjs zkey export verificationkey "$BUILD_DIR/${name}.zkey" "$BUILD_DIR/${name}_vk.json"`
    *   **Resulting Path:** `./circuits/build/withdraw_vk.json`

*   **Conclusion:** The default path in the relayer is incorrect, which will prevent it from starting unless the `WITHDRAW_VK_PATH` environment variable is explicitly and correctly set.

### SDK Path Mismatch

*   **SDK (`sdk/src/proof/prover.ts`):**
    *   **Expected Paths:** The `DEFAULT_CIRCUIT_PATHS` constant defines paths that point directly into the `circuits/` directory and expect a `_final.zkey` suffix.
    *   **Code:**
        ```typescript
        wasmPath: 'circuits/withdraw/withdraw_js/withdraw.wasm',
        zkeyPath: 'circuits/withdraw/withdraw_final.zkey',
        ```

*   **Build Script (`circuits/build.sh`):**
    *   **Actual Paths:** The build script places all outputs inside the `circuits/build/` directory and the final zkey does not have a `_final` suffix.
    *   **Resulting WASM Path:** `circuits/build/withdraw_js/withdraw.wasm`
    *   **Resulting ZKEY Path:** `circuits/build/withdraw.zkey`

*   **Conclusion:** The default paths in the SDK are incorrect. The SDK will fail to load the necessary circuit files, making it impossible to generate any ZK proofs.

## E) VK Provisioning Process is Incomplete and Misdocumented

The process for provisioning verification keys (VKs) is non-functional out-of-the-box due to a missing deployment step and misleading documentation. This will render any newly deployed pool inoperable.

*   **Misleading Documentation (`README.md`):**
    *   **Claim:** The README states, "Groth16 verification keys embedded in program".
    *   **Reality:** The on-chain program does **not** use these embedded constants for verification. The `set_verification_key_v2.rs` instruction shows that VKs must be explicitly written into dedicated on-chain accounts (`VerificationKeyAccountV2` PDAs) after the pool is initialized.

*   **Embedded Keys (`programs/psol-privacy-v2/src/crypto/verification_keys.rs`):**
    *   **Evidence:** This file contains large, hardcoded byte arrays for the VKs of each circuit.
    *   **Function:** These constants are **unused** by the actual proof verification logic. They appear to be code-generated artifacts intended for use by an off-chain script, but they serve no runtime purpose for the on-chain program.

*   **Missing Deployment Step (`scripts/ts/init-pool.ts`):**
    *   **Evidence:** The `init-pool.ts` script, which is the primary tool for deploying a new pool, only calls the `initializePoolV2` instruction.
    *   **Omission:** It **never** calls the required `setVerificationKeyV2` instruction for any of the proof types (Deposit, Withdraw, etc.).

*   **Conclusion:** This is a critical operational failure.
    1.  A newly initialized pool will have no verification keys set on-chain.
    2.  The `pool_config.vk_configured` flag will never be set.
    3.  All calls to the `deposit` or `withdraw` instructions will fail the `require_vk_configured` check.
    4.  **The pool is unusable after deployment.** A separate, missing script is required to read the VKs from the build artifacts and submit them to the on-chain program.
